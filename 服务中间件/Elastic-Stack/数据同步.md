当业务量上升后，由于 mysql 对全文检索或模糊查询支持的能力不强，在系统中查询的地方，往往会出现慢 sql 等，拖累系统其他模块，造成性能低下。

随着 ES 使用普及率的升高，ES 是 mysql 的一个有效补充。我们可以将数据发送到搜索引擎（如 ES）上，由搜索引擎来提供专业的服务。

接下来，就结合工作中实际用到的场景，对数据从 mysql 到 es 的同步进行一些分析。

在实践中我总结出了以下几种方式。

# 第 1 种：同步双写

这是一种最为简单的方式，在将数据写到 mysql 时，同时将数据写到 ES，实现数据的双写。

![](https://pics3.baidu.com/feed/9825bc315c6034a8cea9fafdd5b83e50082376b6.jpeg?token=94cf91b180e52916904dbfff2b367fbc&s=E8223A726560771386471CD80200D0B8)

## 优点：

业务逻辑简单。

## 缺点：

硬编码：有需要写入 mysql 的地方都需要添加写入 ES 的代码；业务强耦合；存在双写失败丢数据风险；性能较差：本来 mysql 的性能就不是很高，再加写一个 ES，系统的性能必然会下降。说明：

上面第 3 点讲到的双写失败风险，包括以下 3 种：

ES 系统不可用；应用系统和 ES 之间的网络故障；应用系统重启，导致系统来不及写入 ES 等。针对这种情况，有数据强一致性要求的，就必须双写放到事物中来处理，但是一旦用上事物，则性能下降更加明显。

# 第 2 种：异步双写（MQ 方式）

针对第一种同步双写的性能和数据丢失问题，可以考虑引入 MQ，从而形成了异步双写的方案，如下图所示：

![](https://pics2.baidu.com/feed/1b4c510fd9f9d72a0833770cca815f30359bbbff.jpeg?token=0f3b4d36c5fa055f7c1a930dd59779fc&s=C8223A728920D2037879C9CD0200D0B0)

由于 MQ 的性能基本比 mysql 高出一个数量级，所以性能可以得到显著的提高。

## 优点：

性能高；不存在丢数据问题。

## 缺点：

硬编码问题：依然存在业务强耦合：依然存在复杂度增加：系统中增加了 mq 的代码，；可能存在时延问题：程序的写入性能提高了，但是由于 MQ 的消费可能由于网络或其它原因导致用户写入的数据不一定可以马上看到，造成延时。

# 第 3 种：异步双写（Worker 方式）

上面两种方案中都存在硬编码问题，也就是有任何对 mysq 进行增删改查的地方要么植入 ES 代码，要么替换为 MQ 代码，代码的侵入性太强。

如果对实时性要求不高的情况下，可以考虑用定时器来处理，具体步骤如下：

数据库的相关表中增加一个字段为 timestamp 的字段，任何 crud 操作都会导致该字段的时间发生变化；原来程序中的 CURD 操作不做任何变化；增加一个定时器程序（京东内部叫 Worker），让该程序按一定的时间周期扫描指定的表，把该时间段内发生变化的数据提取出来；逐条写入到 ES 中。入下图所示

![](https://pics2.baidu.com/feed/a1ec08fa513d269706d003414b50c5ff4216d8de.jpeg?token=107b2f1efc3a4c0e00cbc9a3478272cd&s=E8223E720D20560B14D8E4C9020030BB)

## 优点：

不改变原来代码，没有侵入性、没有硬编码；没有业务强耦合；不改变原来程序的性能；Worker 代码编写简单不需要考虑增删改查。

## 缺点：

时效性较差，由于定时器工作周期不可能设在秒级，所以实时性没有上面 2 中好；对数据库有一定的轮询压力，一种改进方法是将轮询放到压力不大的重库上。

# 第 4 种：Binlog 同步方式：

上面三种方案要么有代码侵入，要么有硬编码，要么有时延，第 4 中方案，可以利用 mysql 的 binlog 来进行同步

![](https://pics2.baidu.com/feed/d833c895d143ad4bda943fb39ca92daba50f06bd.jpeg?token=b30bbc62ba2d74062fcd4f755457b078&s=E8223C724175538A13E5E4C60200E0BB)

具体步骤如下：

1） 读取 mysql 的 binlog 日志，获取指定表的日志信息；

2） 将读取的信息转为 MQ；

3） 编写一个 MQ 消费程序；

4） 不断消费 MQ，每消费完一条消息，将消息写入到 ES 中。

## 优点：

没有代码侵入、没有硬编码；原有系统不需要任何变化，没有感知；性能高；业务解耦，不需要关注原来系统的业务逻辑。

## 缺点：

构建 Binlog 系统复杂；也像方案二，存在 MQ 延时的风险。