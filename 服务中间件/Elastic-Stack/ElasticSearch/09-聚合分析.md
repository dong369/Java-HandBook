# 1 聚合分析

## 1.1 什么是聚合分析？

·搜索引擎用来回答如下问题
请告诉我地址为上海的所有订单？
请告诉我最近1天内创建但没有付款的所有订单？
聚合分析可以回答如下问题
请告诉我最近1周每天的订单成交量有多少？
请告诉我最近1个月每天的平均订单金额是多少？
请告诉我最近半年卖的最火的前5个商品是哪些？



聚合分析，英文为 Aggregation，是es除搜索功能外提供的针对es数据做统计分析的
功能
功能丰富，提供 Bucket、Meti、 Pipeline等多种分析方式，可以满足大部分的分析
需求
实时性高，所有的计算结果都是即时返回的，而 hadoop等大数据系统般都是
T+1级别的



## 1.2 聚合分析-分类

为了便于理解，ES将聚合分析主要分为如下4类：

Bucket，分桶类型，类似SQL中的 GROUP BY语法

Metric，指标分析类型，如计算最大值、最小值、平均值等等

Pipeline，管道分析类型，基于上一级的聚合分析结果进行再分析

Matrⅸ，矩阵分析类型

### 1.2.1 Metric聚合分析

主要分如下两类：
单值分析，只输出一个分析结果
min， max， avg，sum，cardinality

```json
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "min_age": {
      "min": {
        "field": "age"
      }
    }
  }
}

GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "min_age": {
      "min": {
        "field": "age"
      }
    },
    "max_age": {
      "max": {
        "field": "age"
      }
    },
    "avg_age": {
      "avg": {
        "field": "age"
      }
    },
    "sum_age": {
      "sum": {
        "field": "age"
      }
    },
    "card_age": {
      "cardinality": {
        "field": "age"
      }
    }
  }
}
```

多值分析，输出多个分析结果
stats，extended stats，percentile（百分位数统计），percentile rank（百分位数排名），top hits

```json
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "stats_age": {
      "stats": {
        "field": "age"
      }
    }
  }
}

GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "stats_age": {
      "extended_stats": {
        "field": "age"
      }
    }
  }
}

# 百分统计
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "stats_age": {
      "percentiles": {
        "field": "age"
      }
    }
  }
}

# 百分位
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "stats_age": {
      "percentile_ranks": {
        "field": "age",
        "values": [
          12,
          18,
          22
        ]
      }
    }
  }
}
```

### 1.2.2 bucket

Bucket，意为桶，即按照一定的规则将文档分配到不同的桶中，达到分类分析的目的。

按照 Bucket的分桶策略，常见的 Bucket聚合分析如下：Terms、Range、Date Range、Histogram、Date Histogram。

Terms该分桶策略最简单，直接按照term来分桶，如果是tex类型，则按照分词后的结果分桶。

```json
GET test_search_index/_search
{
  "size": 0,
  "aggs": {
    "stats_age": {
      "terms": {
        "field": "job.keyword",
        "size": 5
      }
    }
  }
}
```

